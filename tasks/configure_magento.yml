---

- name: Magento Config | Install packages required by magento
  apt: name={{ item }} state=present update_cache=yes
  with_items:
    - php5-gd
    - php5-mysql
    - php5-curl
    - php5-mcrypt
    - php-apc
  notify:
    - restart php-fpm

- name: Magento Config | Ensure php5-mcrypt module is enabled
  command: php5enmod mcrypt

- name: Magento Config | Mage Setup
  command: chdir={{ magento_src_dir }} ./mage mage-setup .

- name: Magento Config | Mage Stable State
  command: chdir={{ magento_src_dir }} ./mage config-set preferred_state stable

- name: Magento Config | write local.xml file out
  template: src=local.xml.j2 dest={{ magento_src_dir }}/app/etc/local.xml

- name: Magento Config | disable default vhost
  file: path=/etc/nginx/sites-enabled/default state=absent
  notify:
    - restart nginx

- name: Magento Config | write vhost
  template: src=vhost.conf.j2 dest=/etc/nginx/sites-available/{{ magento_project_name }}
  tags: vhost
  notify:
    - restart nginx

- name: Magento Config | enable vhost
  file: src=/etc/nginx/sites-available/{{ magento_project_name }}
        dest=/etc/nginx/sites-enabled/{{ magento_project_name }} state=link
  notify:
    - restart nginx

- name: Magento Config | setup cron
  cron: name='Magento cron' minute='*/5' user='{{ magento_application_user }}'
        job='/bin/sh {{ magento_current_release }}/cron.sh'
